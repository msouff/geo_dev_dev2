{% extends "my_first_app/base.html" %}
{% block app_navigation_items %}
  <li><a href="{% url 'my_first_app:home' %}">Home</a></li>
  <li><a href="{% url 'my_first_app:map' %}">Map</a></li>
{% endblock %}

{% block app_content %}
  <link rel="stylesheet" href="http://www.hydromap.com/openlayers/OpenLayers3/resources/ol.css" type="text/css">
  <style>
    .map {
    height: 750px;
    width: 100%;
  }
  </style>
  <script src="http://www.hydromap.com/openlayers/OpenLayers3/resources/ol.js" type="text/javascript"></script>

  <h1>Impounded Waters in Utah</h1>

  <div id="map" class="map" ></div>

  <script type="text/javascript">
    var styleCache = {};
    var styleFunction = function(feature, resolution) {
      // 2012_Earthquakes_Mag5.kml stores the magnitude of each earthquake in a
      // standards-violating <magnitude> tag in each Placemark.  We extract it from
      // the Placemark's name instead.
      var name = feature.get('name');
      var magnitude = parseFloat(name.substr(2));
      var radius = 5 + 20 * (magnitude - 5);
      var style = styleCache[radius];
      if (!style) {
        style = [new ol.style.Style({
          image: new ol.style.Circle({
            radius: radius,
            fill: new ol.style.Fill({
              color: 'rgba(255, 153, 0, 0.4)'
            }),
            stroke: new ol.style.Stroke({
              color: 'rgba(255, 204, 0, 0.2)',
              width: 1
            })
          })
        })];
        styleCache[radius] = style;
      }
      return style;
    };

    var vector1 = new ol.layer.Vector({
      source: new ol.source.KML({
        projection: ol.proj.get('EPSG:3857'),
        url: '/static/my_first_app/kml/streams_with_dams/doc.kml'
      }),
      style: styleFunction
    });

    var vector2 = new ol.layer.Vector({
      source: new ol.source.KML({
        projection: ol.proj.get('EPSG:3857'),
        url: '/static/my_first_app/kml/watershed_with_dams/doc.kml'
      }),
      style: styleFunction
    });

    var vector = new ol.layer.Vector({
      source: new ol.source.KML({
        projection: ol.proj.get('EPSG:3857'),
        url: '/static/my_first_app/kml/dams/doc.kml'
      }),
      style: styleFunction
    });

    var raster = new ol.layer.Tile({
      source: new ol.source.MapQuest({
        layer: 'sat'
      })
    });

    var map = new ol.Map({
      layers: [raster, vector2, vector1, vector],
      target: 'map',
      view: new ol.View({
        center: ol.proj.transform([-111.592488, 39.588263], 'EPSG:4326', 'EPSG:3857'),
        zoom: 7
      })
    });

    var info = $('#info');
    info.tooltip({
      animation: false,
      trigger: 'manual'
    });

    var displayFeatureInfo = function(pixel) {
      info.css({
        left: pixel[0] + 'px',
        top: (pixel[1] - 15) + 'px'
      });
      var feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
        return feature;
      });
      if (feature) {
        info.tooltip('hide')
            .attr('data-original-title', feature.get('name'))
            .tooltip('fixTitle')
            .tooltip('show');
      } else {
        info.tooltip('hide');
      }
    };

    map.on('pointermove', function(evt) {
      if (evt.dragging) {
        info.tooltip('hide');
        return;
      }
      displayFeatureInfo(map.getEventPixel(evt.originalEvent));
    });

    map.on('click', function(evt) {
      displayFeatureInfo(evt.pixel);
    });
  </script>

{% endblock %}

{% block app_actions %}
  <a href="{% url 'my_first_app:home' %}" class="btn btn-default">Go To home</a>
{% endblock %}